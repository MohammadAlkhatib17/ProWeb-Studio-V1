name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  BUNDLE_SIZE_THRESHOLD: 10 # Percentage threshold for bundle size regression

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for bundle comparison

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Install dependencies
        run: npm install --prefix site

      - name: TypeScript check
        run: npm --prefix site run typecheck

      - name: ESLint check
        run: npm --prefix site run lint

      - name: Prettier check
        run: npm --prefix site run format:check

      - name: Run tests
        run: npm --prefix site test

      - name: Build project with analysis
        run: npm --prefix site run build:analyze

      - name: Generate bundle analysis data
        run: npm --prefix site run analyze:generate

  bundle-size-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Install dependencies
        run: npm install --prefix site

      - name: Build current branch
        run: npm --prefix site run build:analyze

      - name: Generate current bundle analysis
        run: npm --prefix site run analyze:generate

      - name: Save current bundle data
        run: cp reports/bundles/analysis-data.json current-bundle.json

      - name: Checkout base branch
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

      - name: Install dependencies (base)
        run: npm install --prefix site

      - name: Build base branch
        run: npm --prefix site run build:analyze

      - name: Generate base bundle analysis
        run: npm --prefix site run analyze:generate

      - name: Compare bundle sizes
        id: bundle-check
        run: |
          if npm --prefix site run bundle:compare current-bundle.json reports/bundles/analysis-data.json; then
            echo "bundle-check-passed=true" >> $GITHUB_OUTPUT
          else
            echo "bundle-check-passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for bundle size override label
        id: check-override
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name);
            const hasOverride = labels.includes('bundle-size-override');
            console.log('PR labels:', labels);
            console.log('Has override:', hasOverride);
            core.setOutput('has-override', hasOverride);

      - name: Fail on bundle size regression
        if: steps.bundle-check.outputs.bundle-check-passed == 'false' && steps.check-override.outputs.has-override != 'true'
        run: |
          echo "‚ùå Bundle size regression detected!"
          echo "Add 'bundle-size-override' label to override this check."
          echo "See reports/ci/quality-gates.md for more information."
          exit 1
