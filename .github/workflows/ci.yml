name: Comprehensive CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  BUNDLE_SIZE_THRESHOLD: 5 # Percentage threshold for bundle size regression
  NODE_VERSION: '20'
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/pw-browsers

jobs:
  # Step 1: Install and setup
  install:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: site
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Cache node_modules
        uses: actions/cache@v3
        id: npm-cache
        with:
          path: site/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('site/package-lock.json') }}

  # Step 2: TypeScript type checking
  typecheck:
    runs-on: ubuntu-latest
    needs: install
    defaults:
      run:
        working-directory: site
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: site/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('site/package-lock.json') }}

      - name: TypeScript type checking
        run: npm run typecheck

  # Step 3: ESLint and Prettier
  lint:
    runs-on: ubuntu-latest
    needs: install
    defaults:
      run:
        working-directory: site
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: site/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('site/package-lock.json') }}

      - name: ESLint check
        run: npm run lint

      - name: Prettier check
        run: npm run format:check

  # Step 4: Cleanup Quality Gates
  cleanup-validation:
    runs-on: ubuntu-latest
    needs: [typecheck, lint]
    defaults:
      run:
        working-directory: site
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: site/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('site/package-lock.json') }}

      - name: Generate cleanup inventory
        run: npm run cleanup:inventory

      - name: Check for unused code regression
        run: |
          echo "üîç Checking for unused code regression..."
          
          # Check TypeScript unused locals/parameters
          if npx tsc --noEmit --noUnusedLocals --noUnusedParameters 2>&1 | grep -q "error TS6133\|error TS6196"; then
            echo "‚ùå Found unused TypeScript locals or parameters"
            npx tsc --noEmit --noUnusedLocals --noUnusedParameters
            exit 1
          else
            echo "‚úÖ No unused TypeScript locals/parameters found"
          fi
          
          # Check ESLint unused variables
          if npm run lint 2>&1 | grep -q "@typescript-eslint/no-unused-vars"; then
            echo "‚ùå Found unused variables via ESLint"
            npm run lint
            exit 1
          else
            echo "‚úÖ No unused variables detected by ESLint"
          fi

      - name: Validate cleanup thresholds
        run: |
          echo "üìä Validating cleanup quality thresholds..."
          
          # Parse cleanup inventory results
          UNREFERENCED_COUNT=$(node -e "
            const data = require('./reports/cleanup-inventory.json');
            console.log(data.summary.unreferencedFiles.length);
          ")
          
          UNUSED_DEPS_COUNT=$(node -e "
            const data = require('./reports/cleanup-inventory.json');
            console.log(data.summary.potentiallyUnusedDeps.length);
          ")
          
          echo "üìä Current metrics:"
          echo "  Unreferenced files: $UNREFERENCED_COUNT"
          echo "  Potentially unused deps: $UNUSED_DEPS_COUNT"
          
          # Set reasonable thresholds (prevent significant regression)
          MAX_UNREFERENCED_FILES=120  # Allow some buffer from current ~113
          MAX_UNUSED_DEPS=25          # Allow some buffer from current ~18
          
          if [ "$UNREFERENCED_COUNT" -gt "$MAX_UNREFERENCED_FILES" ]; then
            echo "‚ùå Too many unreferenced files: $UNREFERENCED_COUNT (max: $MAX_UNREFERENCED_FILES)"
            exit 1
          fi
          
          if [ "$UNUSED_DEPS_COUNT" -gt "$MAX_UNUSED_DEPS" ]; then
            echo "‚ùå Too many potentially unused dependencies: $UNUSED_DEPS_COUNT (max: $MAX_UNUSED_DEPS)"
            exit 1
          fi
          
          echo "‚úÖ Cleanup quality thresholds met"

      - name: Upload cleanup inventory
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cleanup-inventory-${{ github.sha }}
          path: site/reports/cleanup-inventory*
          retention-days: 30

  # Step 5: Unit tests with Vitest
  unit-tests:
    runs-on: ubuntu-latest
    needs: [typecheck, lint, cleanup-validation]
    defaults:
      run:
        working-directory: site
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: site/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('site/package-lock.json') }}

      - name: Run unit tests
        run: npm run test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vitest-results
          path: site/test-results/
          retention-days: 30

  # Step 5: Build and prepare for E2E
  build:
    runs-on: ubuntu-latest
    needs: unit-tests
    defaults:
      run:
        working-directory: site
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: site/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('site/package-lock.json') }}

      - name: Build project with analysis
        run: npm run build:analyze

      - name: Generate bundle analysis data
        run: npm run analyze:generate

      - name: Check bundle size budgets
        run: |
          echo "üîç Checking bundle size budgets..."
          # Check if total JS bundle exceeds budget
          TOTAL_JS=$(node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('reports/bundles/analysis-data.json', 'utf8'));
            const totalJS = data.bundles.reduce((sum, bundle) => sum + bundle.size, 0);
            console.log(totalJS);
          ")
          MAX_JS_BUDGET=900000  # 900KB max total JS
          if [ "$TOTAL_JS" -gt "$MAX_JS_BUDGET" ]; then
            echo "‚ùå Total JS bundle size ($TOTAL_JS bytes) exceeds budget ($MAX_JS_BUDGET bytes)"
            echo "::error::Bundle size budget exceeded. Total JS: $TOTAL_JS bytes, Budget: $MAX_JS_BUDGET bytes"
            exit 1
          else
            echo "‚úÖ Bundle size within budget: $TOTAL_JS bytes (limit: $MAX_JS_BUDGET bytes)"
          fi

      - name: Run SEO preflight checks
        run: npm run seo:preflight

      - name: Security quality gates
        run: |
          echo "üîí Running security quality gates..."
          
          # Check CSP unsafe-eval
          echo "üõ°Ô∏è Checking CSP for unsafe-eval directive..."
          node ../scripts/check-csp-unsafe-eval.js
          
          # Check environment variable consistency
          echo "üîß Checking environment variable consistency..."
          node ../scripts/check-env-vars-consistency.js

      - name: Cache build output
        uses: actions/cache@v3
        with:
          path: |
            site/.next
            site/reports
          key: ${{ runner.os }}-build-${{ github.sha }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            site/.next
            site/reports/bundles/
          retention-days: 30

  # Step 6: End-to-End tests with Playwright
  e2e-tests:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15
    defaults:
      run:
        working-directory: site
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: site/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('site/package-lock.json') }}

      - name: Restore build cache
        uses: actions/cache@v3
        with:
          path: |
            site/.next
            site/reports
          key: ${{ runner.os }}-build-${{ github.sha }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start application
        run: |
          npm run start &
          echo $! > .server.pid
          # Wait for server to be ready
          timeout 30 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'

      - name: Run Playwright E2E tests
        run: npm run test:e2e

      - name: Stop application
        if: always()
        run: |
          if [ -f .server.pid ]; then
            kill $(cat .server.pid) || true
            rm .server.pid
          fi

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results
          path: |
            site/test-results/
            site/playwright-report/
          retention-days: 30

  # Step 7: Lighthouse CI - Desktop
  lighthouse-desktop:
    runs-on: ubuntu-latest
    needs: e2e-tests
    timeout-minutes: 20
    defaults:
      run:
        working-directory: site
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: site/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('site/package-lock.json') }}

      - name: Restore build cache
        uses: actions/cache@v3
        with:
          path: |
            site/.next
            site/reports
          key: ${{ runner.os }}-build-${{ github.sha }}

      - name: Clean up port 4020
        run: kill -9 $(lsof -t -i:4020) 2>/dev/null || true

      - name: Run Lighthouse CI (Desktop)
        run: npm run ci:perf

      - name: Upload Lighthouse Desktop artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-desktop-reports
          path: |
            site/.lighthouseci/
            site/lhci_reports/
          retention-days: 30

  # Step 8: Lighthouse CI - Mobile
  lighthouse-mobile:
    runs-on: ubuntu-latest
    needs: e2e-tests
    timeout-minutes: 20
    defaults:
      run:
        working-directory: site
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: site/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('site/package-lock.json') }}

      - name: Restore build cache
        uses: actions/cache@v3
        with:
          path: |
            site/.next
            site/reports
          key: ${{ runner.os }}-build-${{ github.sha }}

      - name: Clean up port 4020
        run: kill -9 $(lsof -t -i:4020) 2>/dev/null || true

      - name: Run Lighthouse CI (Mobile)
        run: npm run ci:perf:mobile

      - name: Upload Lighthouse Mobile artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-mobile-reports
          path: |
            site/.lighthouseci/
            site/lhci_reports/
          retention-days: 30

  # Bundle Size Regression Protection for PRs
  bundle-size-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: build
    defaults:
      run:
        working-directory: site
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Build current branch
        run: npm run build:analyze

      - name: Generate current bundle analysis
        run: npm run analyze:generate

      - name: Save current bundle data
        run: cp reports/bundles/analysis-data.json current-bundle.json

      - name: Checkout base branch
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

      - name: Install dependencies (base)
        run: npm ci

      - name: Build base branch
        run: npm run build:analyze

      - name: Generate base bundle analysis
        run: npm run analyze:generate

      - name: Compare bundle sizes
        id: bundle-check
        run: |
          if npm run bundle:compare ../current-bundle.json reports/bundles/analysis-data.json; then
            echo "bundle-check-passed=true" >> $GITHUB_OUTPUT
          else
            echo "bundle-check-passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for bundle size override label
        id: check-override
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name);
            const hasOverride = labels.includes('bundle-size-override');
            console.log('PR labels:', labels);
            console.log('Has override:', hasOverride);
            core.setOutput('has-override', hasOverride);

      - name: Fail on bundle size regression
        if: steps.bundle-check.outputs.bundle-check-passed == 'false' && steps.check-override.outputs.has-override != 'true'
        run: |
          echo "‚ùå Bundle size regression detected!"
          echo ""
          echo "üìä Bundle size has increased beyond the acceptable threshold."
          echo "This may impact application performance and user experience."
          echo ""
          echo "üîß To override this check:"
          echo "1. Add the 'bundle-size-override' label to this PR"
          echo "2. Document the justification in a PR comment"
          echo "3. See reports/ci/quality-gates.md for acceptable rationale"
          echo ""
          echo "üí° Consider optimizing bundle size before overriding:"
          echo "- Remove unused dependencies"
          echo "- Use dynamic imports for large components"
          echo "- Optimize images and assets"
          echo "- Check for duplicate dependencies"
          exit 1

      - name: Upload bundle analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-analysis-reports
          path: |
            current-bundle.json
            site/reports/bundles/analysis-data.json
            site/reports/bundles/summary.md
          retention-days: 30

  # Summary job for status checks
  ci-summary:
    runs-on: ubuntu-latest
    needs: [lighthouse-desktop, lighthouse-mobile, bundle-size-check]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "üîç CI Pipeline Summary"
          echo "======================"
          
          if [[ "${{ needs.lighthouse-desktop.result }}" == "success" ]]; then
            echo "‚úÖ Lighthouse Desktop: PASSED"
          else
            echo "‚ùå Lighthouse Desktop: FAILED"
          fi
          
          if [[ "${{ needs.lighthouse-mobile.result }}" == "success" ]]; then
            echo "‚úÖ Lighthouse Mobile: PASSED"
          else
            echo "‚ùå Lighthouse Mobile: FAILED"
          fi
          
          if [[ "${{ needs.bundle-size-check.result }}" == "success" ]] || [[ "${{ needs.bundle-size-check.result }}" == "skipped" ]]; then
            echo "‚úÖ Bundle Size Check: PASSED"
          else
            echo "‚ùå Bundle Size Check: FAILED"
          fi

      - name: Fail pipeline if critical jobs failed
        if: needs.lighthouse-desktop.result == 'failure' || needs.lighthouse-mobile.result == 'failure' || needs.bundle-size-check.result == 'failure'
        run: |
          echo "‚ùå CI Pipeline failed due to critical job failures"
          exit 1
