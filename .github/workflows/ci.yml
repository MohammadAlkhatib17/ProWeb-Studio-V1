name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  BUNDLE_SIZE_THRESHOLD: 5 # Percentage threshold for bundle size regression (tightened)

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for bundle comparison

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Install dependencies
        run: npm install --prefix site

      - name: TypeScript check
        run: npm --prefix site run typecheck

      - name: ESLint check
        run: npm --prefix site run lint

      - name: Prettier check
        run: npm --prefix site run format:check

      - name: Run tests
        run: npm --prefix site test

      - name: Build project with analysis
        run: npm --prefix site run build:analyze

      - name: Generate bundle analysis data
        run: npm --prefix site run analyze:generate

      - name: Run SEO preflight checks post-build
        run: npm --prefix site run seo:preflight

      - name: Security quality gates
        run: |
          echo "üîí Running security quality gates..."
          
          # Check CSP unsafe-eval
          echo "üõ°Ô∏è Checking CSP for unsafe-eval directive..."
          node scripts/check-csp-unsafe-eval.js
          
          # Check environment variable consistency
          echo "üîß Checking environment variable consistency..."
          node scripts/check-env-vars-consistency.js

      - name: Upload CI reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-reports
          path: |
            site/reports/bundles/analysis-data.json
            site/reports/bundles/summary.md
          retention-days: 30

  # Bundle Size Regression Protection
  # 
  # This job checks for bundle size regressions by comparing the current PR
  # against the base branch. If bundle size increases beyond the threshold,
  # the check fails unless overridden.
  #
  # Override Mechanism:
  # - Add 'bundle-size-override' label to the PR
  # - Document justification in PR comments
  # - See reports/ci/quality-gates.md for acceptable rationale
  #
  # Acceptable Override Reasons:
  # - New features requiring additional dependencies
  # - Critical library updates for security/performance
  # - Temporary increases with optimization plan
  # - Business-critical functionality with approved trade-offs
  bundle-size-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Install dependencies
        run: npm install --prefix site

      - name: Build current branch
        run: npm --prefix site run build:analyze

      - name: Generate current bundle analysis
        run: npm --prefix site run analyze:generate

      - name: Save current bundle data
        run: cp reports/bundles/analysis-data.json current-bundle.json

      - name: Checkout base branch
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

      - name: Install dependencies (base)
        run: npm install --prefix site

      - name: Build base branch
        run: npm --prefix site run build:analyze

      - name: Generate base bundle analysis
        run: npm --prefix site run analyze:generate

      - name: Compare bundle sizes
        id: bundle-check
        run: |
          if npm --prefix site run bundle:compare current-bundle.json reports/bundles/analysis-data.json; then
            echo "bundle-check-passed=true" >> $GITHUB_OUTPUT
          else
            echo "bundle-check-passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for bundle size override label
        id: check-override
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name);
            const hasOverride = labels.includes('bundle-size-override');
            console.log('PR labels:', labels);
            console.log('Has override:', hasOverride);
            core.setOutput('has-override', hasOverride);

      - name: Fail on bundle size regression
        if: steps.bundle-check.outputs.bundle-check-passed == 'false' && steps.check-override.outputs.has-override != 'true'
        run: |
          echo "‚ùå Bundle size regression detected!"
          echo ""
          echo "üìä Bundle size has increased beyond the acceptable threshold."
          echo "This may impact application performance and user experience."
          echo ""
          echo "üîß To override this check:"
          echo "1. Add the 'bundle-size-override' label to this PR"
          echo "2. Document the justification in a PR comment"
          echo "3. See reports/ci/quality-gates.md for acceptable rationale"
          echo ""
          echo "üí° Consider optimizing bundle size before overriding:"
          echo "- Remove unused dependencies"
          echo "- Use dynamic imports for large components"
          echo "- Optimize images and assets"
          echo "- Check for duplicate dependencies"
          exit 1

      - name: Upload bundle analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-analysis-reports
          path: |
            current-bundle.json
            reports/bundles/analysis-data.json
            reports/bundles/summary.md
          retention-days: 30
